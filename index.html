<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Smart Traffic Assistance (Thailand)</title>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #f8fafc;
        }

        .wrap {
            display: grid;
            grid-template-columns: 520px 1fr;
            height: 100vh;
        }

        .left {
            padding: 20px;
            border-right: 1px solid #1e293b;
            overflow-y: auto;
            background: #1e293b;
        }

        .card {
            background: #334155;
            border: 1px solid #475569;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .hint {
            color: #94a3b8;
            font-size: 13px;
            line-height: 1.5;
            margin-top: 5px;
        }

        .title {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 10px;
            color: #38bdf8;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .num-box {
            text-align: center;
            background: #1e293b;
            padding: 10px;
            border-radius: 8px;
        }

        .num {
            font-size: 28px;
            font-weight: 800;
            display: block;
        }

        .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-HIGH {
            background: #ef4444;
            color: white;
        }

        .badge-MED {
            background: #f59e0b;
            color: white;
        }

        .badge-LOW {
            background: #10b981;
            color: white;
        }

        .live-tag {
            font-size: 10px;
            color: #ef4444;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        .live-tag::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.3;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        video {
            width: 100%;
            border-radius: 8px;
            background: #000;
            margin-top: 10px;
            height: 180px;
            object-fit: cover;
        }

        .img-placeholder {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            height: 180px;
            object-fit: cover;
            display: none;
        }

        h1 {
            font-size: 22px;
            margin: 0 0 20px 0;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.online {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        /* Leaflet Specific */
        .leaflet-container {
            background: #0f172a !important;
        }

        .map-label div {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .google-map-label {
            text-shadow: 0 0 4px #000, 0 0 4px #000;
            background: rgba(15, 23, 42, 0.7);
            padding: 2px 4px;
            border-radius: 4px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <div class="wrap">
        <div class="left">
            <h1>
                <div id="statusDot" class="status-dot"></div>
                Smart Traffic Dashboard
            </h1>

            <div id="roadCards"></div>

            <div class="card">
                <div class="title">Color coding System</div>
                <div class="hint">
                    Real-time color calculation based on vehicle density (2s moving average):
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        <li style="color: #ef4444;">Red (High): â‰¥ <span id="thRed">25</span></li>
                        <li style="color: #f59e0b;">Yellow (Medium): â‰¥ <span id="thYellow">10</span></li>
                        <li style="color: #10b981;">Green (Low): &lt; 10</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script>
        // Configuration for 5 roads
        const ROUTES_CONFIG = [
            {
                id: "krungthonburi",
                name: "Krung Thonburi Rd",
                video: "./demo/cctv_krungthonburi.mp4",
                start: { lat: 13.7217, lng: 100.5015 },
                end: { lat: 13.7248, lng: 100.5156 },
            },
            {
                id: "charoenkrung",
                name: "Charoen Krung Rd",
                video: "./demo/cctv_charoenkrung.mp4",
                start: { lat: 13.7049, lng: 100.5073 },
                end: { lat: 13.7283, lng: 100.5272 },
            },
            {
                id: "ratchawithi",
                name: "Ratchawithi Rd",
                video: "./demo/cctv_ratchawithi.mp4",
                start: { lat: 13.7983, lng: 100.5207 },
                end: { lat: 13.7637, lng: 100.5383 },
            },
            {
                id: "rama9",
                name: "Rama 9 Rd",
                video: "./demo/cctv_rama9.mp4",
                start: { lat: 13.7507, lng: 100.6106 },
                end: { lat: 13.7538, lng: 100.5677 },
            },
            {
                id: "asokdindaeng",
                name: "Asokâ€“Din Daeng",
                video: "./demo/cctv_asokdindaeng.mp4",
                start: { lat: 13.7533, lng: 100.5631 },
                end: { lat: 13.7640, lng: 100.5382 },
            },
        ];

        let map;
        let polylines = {};
        let markers = {};
        const roadData = {};

        // Initialize cards immediately
        ROUTES_CONFIG.forEach(createRoadCard);

        function initMap() {
            const hasGoogle = typeof google !== 'undefined' && google.maps;
            const keyPlaceholder = 'YOUR_API_KEY';
            const scripts = document.getElementsByTagName('script');
            let keyFixed = false;
            for (let s of scripts) {
                if (s.src.includes('maps.googleapis.com') && !s.src.includes(keyPlaceholder)) {
                    keyFixed = true;
                }
            }

            if (!hasGoogle || !keyFixed) {
                console.warn("Google Maps not loaded or key missing. Falling back to Leaflet.");
                initLeafletMap();
                return;
            }

            try {
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 13.74, lng: 100.55 },
                    zoom: 13,
                    styles: [
                        { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                        { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                        { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                        { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                        { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
                        { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
                        { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }
                    ]
                });

                const directionsService = new google.maps.DirectionsService();

                ROUTES_CONFIG.forEach(r => {
                    directionsService.route({
                        origin: r.start,
                        destination: r.end,
                        travelMode: 'DRIVING'
                    }, (result, status) => {
                        if (status === 'OK') {
                            polylines[r.id] = new google.maps.Polyline({
                                path: result.routes[0].overview_path,
                                geodesic: true,
                                strokeColor: "#10b981",
                                strokeOpacity: 0.8,
                                strokeWeight: 8,
                                map: map
                            });

                            // Create Marker for counts
                            const midPoint = result.routes[0].overview_path[Math.floor(result.routes[0].overview_path.length / 2)];
                            markers[r.id] = new google.maps.Marker({
                                position: midPoint,
                                map: map,
                                label: {
                                    text: "0 | 0",
                                    color: "white",
                                    fontSize: "12px",
                                    fontWeight: "bold"
                                },
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 0, // Hide the dot
                                }
                            });
                        }
                    });
                });
            } catch (e) {
                console.error("Google Maps init error:", e);
                initLeafletMap();
            }

            initWebSocket();
        }

        function initLeafletMap() {
            map = L.map('map').setView([13.74, 100.55], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            ROUTES_CONFIG.forEach(r => {
                const path = [[r.start.lat, r.start.lng], [r.end.lat, r.end.lng]];
                polylines[r.id] = L.polyline(path, {
                    color: "#10b981",
                    weight: 8,
                    opacity: 0.8
                }).addTo(map);

                // Leaflet Marker Fallback
                const mid = [(r.start.lat + r.end.lat) / 2, (r.start.lng + r.end.lng) / 2];
                const labelIcon = L.divIcon({
                    className: 'map-label',
                    html: `<div id="map-lbl-${r.id}" style="background:rgba(15,23,42,0.8); color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold; white-space:nowrap; border:1px solid #38bdf8;">0 | 0</div>`,
                    iconSize: [40, 20],
                    iconAnchor: [20, 10]
                });
                markers[r.id] = L.marker(mid, { icon: labelIcon }).addTo(map);
            });

            initWebSocket();
        }

        function handleMediaError(id) {
            const video = document.getElementById(`vid-${id}`);
            const img = document.getElementById(`img-${id}`);
            video.style.display = 'none';
            img.style.display = 'block';
        }

        function createRoadCard(r) {
            const container = document.getElementById("roadCards");
            const imgPath = `./demo/${r.id}.png`;
            const html = `
        <div class="card" id="card-${r.id}">
          <div class="row">
            <div>
              <div class="title" style="margin:0">${r.name}</div>
              <div class="live-tag">LIVE FEED</div>
            </div>
            <div id="badge-${r.id}" class="badge badge-LOW">Low (Green)</div>
          </div>
          <div class="grid">
            <div class="num-box">
              <span id="v-${r.id}" class="num">0</span>
              <span class="label">Vehicles</span>
            </div>
            <div class="num-box">
              <span id="p-${r.id}" class="num">0</span>
              <span class="label">People</span>
            </div>
          </div>
          <video id="vid-${r.id}" autoplay muted loop src="${r.video}" onerror="handleMediaError('${r.id}')" poster="${imgPath}"></video>
          <img id="img-${r.id}" class="img-placeholder" src="${imgPath}" />
        </div>
      `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function initWebSocket() {
            // Attempt to connect to local backend (for local dev)
            const wsUrl = `ws://${location.hostname}:8000/ws`;
            console.log("Attempting to connect to backend:", wsUrl);

            const ws = new WebSocket(wsUrl);
            let isConnected = false;

            ws.onopen = () => {
                isConnected = true;
                document.getElementById("statusDot").classList.add("online");
                console.log("WebSocket Connected");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.roads) {
                    Object.keys(data.roads).forEach(id => {
                        const r = data.roads[id];
                        updateUI(id, r);
                        updateMap(id, r.level);
                    });
                }
            };

            ws.onclose = () => {
                if (isConnected) {
                    document.getElementById("statusDot").classList.remove("online");
                    console.log("WebSocket Disconnected. Retrying in 2s...");
                    setTimeout(initWebSocket, 2000);
                } else {
                    console.warn("Backend not found. Switching to Client-Side Simulation Mode.");
                    startClientSimulation();
                }
            };

            ws.onerror = () => {
                ws.close();
            };
        }

        function startClientSimulation() {
            document.getElementById("statusDot").classList.add("online");
            document.getElementById("statusDot").style.background = "#38bdf8"; // Blue for simulation mode
            document.getElementById("statusDot").style.boxShadow = "0 0 10px #38bdf8";

            setInterval(() => {
                const now = Date.now();
                const roads = {};
                const base_v = {
                    krungthonburi: 20,
                    charoenkrung: 15,
                    ratchawithi: 30,
                    rama9: 25,
                    asokdindaeng: 35
                };

                ROUTES_CONFIG.forEach(r => {
                    const v = Math.max(0, Math.floor(base_v[r.id] + (Math.random() * 15 - 5)));
                    const p = Math.max(0, Math.floor(5 + (Math.random() * 6 - 3)));

                    let level = "LOW";
                    if (v >= 25) level = "HIGH";
                    else if (v >= 10) level = "MED";

                    updateUI(r.id, {
                        counts_smooth: { vehicles: v, people: p },
                        level: level
                    });
                    updateMap(r.id, level);
                });
            }, 1000);
        }

        function updateUI(id, road) {
            const v = road.counts_smooth.vehicles;
            const p = road.counts_smooth.people;
            document.getElementById(`v-${id}`).innerText = v;
            document.getElementById(`p-${id}`).innerText = p;

            // Update Map Label
            if (markers[id]) {
                const text = `ðŸš— ${v} | ðŸ‘¤ ${p}`;
                if (markers[id].setLabel) {
                    // Google
                    markers[id].setLabel({
                        text: text,
                        color: "white",
                        fontSize: "11px",
                        fontWeight: "bold",
                        className: "google-map-label"
                    });
                } else {
                    // Leaflet
                    const el = document.getElementById(`map-lbl-${id}`);
                    if (el) el.innerHTML = text;
                }
            }

            const badge = document.getElementById(`badge-${id}`);
            badge.className = `badge badge-${road.level}`;
            badge.innerText = road.level === "HIGH" ? "High (Red)" : (road.level === "MED" ? "Medium (Yellow)" : "Low (Green)");
        }

        function updateMap(id, level) {
            if (polylines[id]) {
                let color = "#10b981"; // green
                if (level === "HIGH") color = "#ef4444"; // red
                else if (level === "MED") color = "#f59e0b"; // yellow

                if (polylines[id].setOptions) {
                    // Google Maps
                    polylines[id].setOptions({ strokeColor: color });
                } else if (polylines[id].setStyle) {
                    // Leaflet
                    polylines[id].setStyle({ color: color });
                }
            }
        }
    </script>
    <!-- Replace YOUR_API_KEY with your actual Google Maps API Key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
    <script>
        // Automatic fallback if google is not defined after 5 seconds
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof google === 'undefined' || !google.maps) {
                    if (typeof initMap === 'function') initMap();
                }
            }, 3000);
        });
    </script>
</body>

</html>